<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>é•·è¼©åœ–ç”¢ç”Ÿå™¨ 4.1 - AI æ–‡æ¡ˆ + AI èƒŒæ™¯</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@700&family=Noto+Sans+TC:wght@900&display=swap" rel="stylesheet">
  <style>
    body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    canvas {
      background-image: linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee),
                        linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee);
      background-size: 20px 20px;
      background-position: 0 0, 10px 10px;
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    }

    .loader {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #a855f7;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>

<body class="bg-slate-100 min-h-screen flex flex-col items-center py-4">
  <header class="text-center mb-4">
    <h1 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-red-600 to-yellow-500 mb-1 drop-shadow-sm">
      ğŸŒ¸ ç¶“å…¸é•·è¼©åœ–ç”¢ç”Ÿå™¨ 4.1
    </h1>
    <p class="text-gray-500 text-sm">AI æ–‡æ¡ˆ + AI èƒŒæ™¯ï¼ˆéœ€æ­é…å¾Œç«¯ server.jsï¼‰</p>
  </header>

  <main class="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-12 gap-6 px-4">
    <div class="lg:col-span-5 space-y-4 h-[85vh] overflow-y-auto no-scrollbar pb-20">

      <!-- æ–‡å­—å…§å®¹ -->
      <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-blue-500">
        <h2 class="font-bold text-gray-700 mb-2 flex items-center">ğŸ“ æ–‡å­—å…§å®¹èˆ‡æ’ç‰ˆ</h2>

        <textarea id="customText" rows="3"
          class="w-full bg-gray-50 border border-gray-300 rounded p-2 text-lg focus:ring-2 focus:ring-blue-400 outline-none mb-3"
          placeholder="æ—©å®‰ï¼&#10;ç¥æ‚¨é †å¿ƒå¦‚æ„">èªåŒè«‹åˆ†äº«&#10;å¹³å®‰å–œæ¨‚</textarea>

        <!-- AI ç”Ÿæˆæ–‡æ¡ˆæŒ‰éˆ• -->
        <div class="flex items-center gap-2 mb-3">
          <select id="greetTone" class="flex-1 p-2 border rounded bg-gray-50 text-sm">
            <option value="morning">æ—©å®‰ç¥ç¦</option>
            <option value="night">æ™šå®‰ç¥ç¦</option>
            <option value="health" selected>å¥åº·å¹³å®‰</option>
            <option value="festival">ç¯€æ—¥è³€è©</option>
            <option value="buddha">ä½›ç³»èªéŒ„</option>
          </select>

          <button onclick="generateAiGreeting()" id="aiGreetingBtn"
            class="bg-blue-600 text-white px-3 py-2 rounded hover:bg-blue-700 font-bold text-sm flex items-center gap-2 whitespace-nowrap">
            <span>AI æ–‡æ¡ˆ</span>
            <div id="aiGreetingLoader" class="loader hidden"></div>
          </button>
        </div>

        <div class="grid grid-cols-2 gap-3 mb-3">
          <label class="flex items-center space-x-2 cursor-pointer bg-gray-100 p-2 rounded hover:bg-gray-200">
            <input type="checkbox" id="isVertical" class="w-5 h-5 text-blue-600 rounded" onchange="drawCanvas()">
            <span class="font-bold text-gray-700">ç›´æ’æ–‡å­— (Vertical)</span>
          </label>
          <label class="flex items-center space-x-2 cursor-pointer bg-gradient-to-r from-pink-100 to-yellow-100 p-2 rounded hover:from-pink-200 hover:to-yellow-200">
            <input type="checkbox" id="isRainbow" class="w-5 h-5 text-pink-600 rounded" onchange="drawCanvas()">
            <span class="font-bold text-transparent bg-clip-text bg-gradient-to-r from-red-500 to-purple-600">ä¸ƒå½©éœ“è™¹å­—</span>
          </label>
        </div>

        <div class="space-y-2 bg-gray-50 p-3 rounded">
          <div class="flex items-center justify-between">
            <span class="text-xs font-bold text-gray-500">å·¦å³ä½ç½® (X)</span>
            <input type="range" id="posX" min="0" max="100" value="50" class="w-2/3 h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer">
          </div>
          <div class="flex items-center justify-between">
            <span class="text-xs font-bold text-gray-500">ä¸Šä¸‹ä½ç½® (Y)</span>
            <input type="range" id="posY" min="0" max="100" value="50" class="w-2/3 h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer">
          </div>
        </div>
      </div>

      <!-- æ¨£å¼èª¿æ•´ -->
      <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-yellow-500">
        <h2 class="font-bold text-gray-700 mb-2">ğŸ¨ æ¨£å¼èª¿æ•´</h2>
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-xs font-bold text-gray-500 block mb-1">æ–‡å­—å¤§å°</label>
            <input type="range" id="fontSize" min="30" max="120" value="60" class="w-full accent-yellow-500">
          </div>
          <div>
            <label class="text-xs font-bold text-gray-500 block mb-1">ä¸»è¦é¡è‰²</label>
            <input type="color" id="textColor" value="#FFFF00" class="w-full h-8 cursor-pointer rounded border border-gray-300">
          </div>
          <div>
            <label class="text-xs font-bold text-gray-500 block mb-1">æé‚Šé¡è‰²</label>
            <input type="color" id="strokeColor" value="#000000" class="w-full h-8 cursor-pointer rounded border border-gray-300">
          </div>
          <div>
            <label class="text-xs font-bold text-gray-500 block mb-1">æé‚Šç²—ç´°</label>
            <input type="range" id="strokeWidth" min="0" max="15" value="6" class="w-full accent-gray-700">
          </div>
        </div>
        <div class="mt-3">
          <label class="text-xs font-bold text-gray-500 block mb-1">é¸æ“‡å­—é«”</label>
          <select id="fontFamily" onchange="drawCanvas()" class="w-full p-2 border rounded bg-gray-50">
            <option value="'Noto Serif TC', serif">å®‹é«” (èŠé‡)</option>
            <option value="'Noto Sans TC', sans-serif">é»‘é«” (ç¾ä»£)</option>
            <option value="'Microsoft JhengHei', sans-serif" selected>å¾®è»Ÿæ­£é»‘é«” (ç¶“å…¸)</option>
            <option value="cursive">æ¨™æ¥·é«” (æ›¸æ³•)</option>
          </select>
        </div>
      </div>

      <!-- èƒŒæ™¯åœ–ç‰‡ -->
      <div class="bg-white p-4 rounded-xl shadow-md border-l-4 border-purple-500">
        <h2 class="font-bold text-gray-700 mb-2">ğŸŒ„ èƒŒæ™¯åœ–ç‰‡</h2>

        <div class="flex gap-2 mb-3">
          <input type="text" id="aiImagePrompt" placeholder="AI é—œéµå­—ï¼šä¾‹å¦‚ è“®èŠ±, ä½›ç¥–, æ—¥å‡º"
            class="flex-1 border p-2 rounded text-sm focus:border-purple-500 outline-none">
          <button onclick="generateAiImage()" id="aiImgBtn"
            class="bg-purple-600 text-white px-3 py-2 rounded hover:bg-purple-700 font-bold text-sm flex items-center gap-2 whitespace-nowrap">
            <span>AI ç”Ÿæˆ</span>
            <div id="aiImgLoader" class="loader hidden"></div>
          </button>
        </div>

        <!-- ä¿ç•™ä½ åŸæœ¬çš„ç¸®åœ–ï¼ˆæœ¬åœ° fallback ç”¨ï¼‰ -->
        <div class="grid grid-cols-4 gap-2">
          <img src="https://images.unsplash.com/photo-1516021876483-37651c51c14b?w=200&q=80" onclick="changeBg(this.src)" class="cursor-pointer h-14 w-full object-cover rounded border hover:border-purple-500">
          <img src="https://images.unsplash.com/photo-1621258284534-192a0e445345?w=200&q=80" onclick="changeBg(this.src)" class="cursor-pointer h-14 w-full object-cover rounded border hover:border-purple-500">
          <img src="https://images.unsplash.com/photo-1507643179173-8b03236ea67e?w=200&q=80" onclick="changeBg(this.src)" class="cursor-pointer h-14 w-full object-cover rounded border hover:border-purple-500">
          <img src="https://images.unsplash.com/photo-1469474968028-56623f02e42e?w=200&q=80" onclick="changeBg(this.src)" class="cursor-pointer h-14 w-full object-cover rounded border hover:border-purple-500">
        </div>

        <label class="block mt-2 text-center text-xs text-blue-500 cursor-pointer underline hover:text-blue-700">
          ğŸ“‚ ä¸Šå‚³è‡ªå·±çš„ç…§ç‰‡
          <input type="file" id="uploadInput" class="hidden" accept="image/*" onchange="handleUpload(this)">
        </label>
      </div>

      <button onclick="downloadImage()"
        class="w-full bg-green-600 hover:bg-green-700 text-white font-black py-3 rounded-xl text-xl shadow-lg transition transform hover:scale-[1.02]">
        â¬‡ï¸ ä¸‹è¼‰åœ–ç‰‡å‚³ LINE
      </button>
    </div>

    <div class="lg:col-span-7 flex flex-col items-center justify-start bg-gray-200 rounded-xl p-4 min-h-[500px]">
      <canvas id="memeCanvas" width="800" height="800" class="bg-white w-full max-w-[600px] h-auto rounded shadow-2xl"></canvas>
      <p class="text-xs text-gray-500 mt-3">æç¤ºï¼šè‹¥æ–‡å­—è¶…å‡ºç•«é¢ï¼Œè«‹èª¿æ•´æ–‡å­—å¤§å°æˆ–ä½ç½® X/Y</p>
    </div>
  </main>

  <script>
    const canvas = document.getElementById('memeCanvas');
    const ctx = canvas.getContext('2d');

    const textInput = document.getElementById('customText');
    const fontSizeInput = document.getElementById('fontSize');
    const textColorInput = document.getElementById('textColor');
    const strokeColorInput = document.getElementById('strokeColor');
    const strokeWidthInput = document.getElementById('strokeWidth');
    const fontFamilyInput = document.getElementById('fontFamily');
    const posXInput = document.getElementById('posX');
    const posYInput = document.getElementById('posY');
    const isVerticalInput = document.getElementById('isVertical');
    const isRainbowInput = document.getElementById('isRainbow');
    const greetToneInput = document.getElementById('greetTone');

    let currentBgImage = new Image();
    currentBgImage.crossOrigin = "anonymous";
    currentBgImage.src = 'https://images.unsplash.com/photo-1516021876483-37651c51c14b?w=800&q=80';
    currentBgImage.onload = drawCanvas;

    const inputs = [textInput, fontSizeInput, textColorInput, strokeColorInput, strokeWidthInput, posXInput, posYInput];
    inputs.forEach(el => el.addEventListener('input', drawCanvas));

    function drawCanvas() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (currentBgImage.complete && currentBgImage.naturalWidth !== 0) {
        const scale = Math.max(canvas.width / currentBgImage.width, canvas.height / currentBgImage.height);
        const x = (canvas.width / 2) - (currentBgImage.width / 2) * scale;
        const y = (canvas.height / 2) - (currentBgImage.height / 2) * scale;
        ctx.drawImage(currentBgImage, x, y, currentBgImage.width * scale, currentBgImage.height * scale);
      } else {
        ctx.fillStyle = "#fff";
        ctx.fillRect(0,0, canvas.width, canvas.height);
      }

      const fontSize = parseInt(fontSizeInput.value);
      const fontFamily = fontFamilyInput.value;
      ctx.font = `bold ${fontSize}px ${fontFamily}`;
      ctx.textBaseline = 'top';

      const text = textInput.value;
      const lines = text.split('\n');
      const isVertical = isVerticalInput.checked;

      const offsetX = (parseInt(posXInput.value) - 50) * (canvas.width / 50);
      const offsetY = (parseInt(posYInput.value) - 50) * (canvas.height / 50);

      let fillStyle;
      if (isRainbowInput.checked) {
        const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
        gradient.addColorStop(0, "red");
        gradient.addColorStop(0.2, "orange");
        gradient.addColorStop(0.4, "yellow");
        gradient.addColorStop(0.6, "green");
        gradient.addColorStop(0.8, "blue");
        gradient.addColorStop(1, "purple");
        fillStyle = gradient;
      } else {
        fillStyle = textColorInput.value;
      }

      ctx.fillStyle = fillStyle;
      ctx.strokeStyle = strokeColorInput.value;
      ctx.lineWidth = parseInt(strokeWidthInput.value);
      ctx.lineJoin = 'round';

      if (isVertical) drawVerticalText(lines, fontSize, offsetX, offsetY);
      else drawHorizontalText(lines, fontSize, offsetX, offsetY);
    }

    function drawHorizontalText(lines, fontSize, offsetX, offsetY) {
      ctx.textAlign = 'center';
      const lineHeight = fontSize * 1.2;
      const totalHeight = lines.length * lineHeight;
      const startY = (canvas.height - totalHeight) / 2 + offsetY;
      const startX = (canvas.width / 2) + offsetX;

      lines.forEach((line, index) => {
        const y = startY + (index * lineHeight);
        ctx.shadowColor = "rgba(0,0,0,0.5)";
        ctx.shadowBlur = 4;
        ctx.strokeText(line, startX, y);
        ctx.shadowBlur = 0;
        ctx.fillText(line, startX, y);
      });
    }

    function drawVerticalText(lines, fontSize, offsetX, offsetY) {
      const lineHeight = fontSize * 1.2;
      const totalWidth = lines.length * lineHeight;
      let currentX = (canvas.width / 2) + (totalWidth / 2) - (lineHeight/2) + offsetX;

      const maxChars = Math.max(...lines.map(l => l.length));
      const totalHeight = maxChars * fontSize;
      const startY = (canvas.height - totalHeight) / 2 + offsetY;

      lines.forEach((line) => {
        let currentY = startY;
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          ctx.textAlign = 'center';

          ctx.shadowColor = "rgba(0,0,0,0.5)";
          ctx.shadowBlur = 4;
          ctx.strokeText(char, currentX, currentY);

          ctx.shadowBlur = 0;
          ctx.fillText(char, currentX, currentY);

          currentY += fontSize;
        }
        currentX -= lineHeight;
      });
    }

    function changeBg(src) {
      currentBgImage.src = src.replace("w=200", "w=800");
    }

    function handleUpload(input) {
      if (input.files && input.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) { currentBgImage.src = e.target.result; }
        reader.readAsDataURL(input.files[0]);
      }
    }

    async function generateAiGreeting() {
      const btn = document.getElementById('aiGreetingBtn');
      const loader = document.getElementById('aiGreetingLoader');
      btn.disabled = true;
      loader.classList.remove('hidden');

      try {
        const res = await fetch('/api/greeting', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tone: greetToneInput.value,
            maxLines: 3
          })
        });
        if (!res.ok) throw new Error('Greeting API failed');
        const data = await res.json();

        textInput.value = data.text || "å¹³å®‰å–œæ¨‚\nèªåŒè«‹åˆ†äº«";
        drawCanvas();
      } catch (e) {
        alert('AI æ–‡æ¡ˆç”¢ç”Ÿå¤±æ•—ï¼š' + e.message);
      } finally {
        btn.disabled = false;
        loader.classList.add('hidden');
      }
    }

    async function generateAiImage() {
      const prompt = document.getElementById('aiImagePrompt').value;
      const btn = document.getElementById('aiImgBtn');
      const loader = document.getElementById('aiImgLoader');

      if(!prompt) return alert('è«‹è¼¸å…¥é—œéµå­—');

      btn.disabled = true;
      loader.classList.remove('hidden');

      try {
        const res = await fetch('/api/image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            prompt,
            size: "1024x1024"
          })
        });
        if (!res.ok) throw new Error('Image API failed');
        const data = await res.json();

        if (!data.dataUrl) throw new Error('No image dataUrl returned');
        currentBgImage.src = data.dataUrl; // base64 ç›´æ¥å¡
      } catch (e) {
        alert('AI åœ–ç‰‡ç”¢ç”Ÿå¤±æ•—ï¼š' + e.message);
      } finally {
        btn.disabled = false;
        loader.classList.add('hidden');
      }
    }

    function downloadImage() {
      const link = document.createElement('a');
      link.download = `é•·è¼©åœ–_${Date.now()}.png`;
      link.href = canvas.toDataURL('image/png');
      link.click();
    }
  </script>
</body>
</html>
