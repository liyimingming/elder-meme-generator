<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•å€™åœ–ç”¢ç”Ÿå™¨ 2.0 - æ™ºæ…§ç¥ç¦ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@600;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; }
        /* ä½¿ç”¨è¥¯ç·šé«”è®“é•·è¼©åœ–æ›´æœ‰å‘³é“ */
        .serif-font { font-family: 'Noto Serif TC', serif; }
        canvas { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-orange-50 min-h-screen flex flex-col items-center py-6">

    <header class="text-center mb-4 px-4">
        <h1 class="text-3xl font-black text-red-600 mb-1">ğŸŒ… é•·è¼©åœ–ç”¢ç”Ÿå™¨ 2.0</h1>
        <p id="holiday-msg" class="text-green-700 font-bold text-lg">å¹³å®‰å–œæ¨‚ï¼Œæ—¥æ—¥æ˜¯å¥½æ—¥</p>
    </header>

    <main class="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-2 gap-6 px-4">
        
        <div class="bg-white p-5 rounded-xl shadow-lg border-2 border-orange-200 space-y-6 h-fit">
            
            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                <label class="block text-blue-800 font-bold mb-2 flex items-center">
                    ğŸ¤– AI å¯«ä½œåŠ©æ‰‹ <span class="text-xs font-normal ml-2 text-gray-500">(è¼¸å…¥å°è±¡ï¼Œå¹«ä½ æƒ³æ–‡æ¡ˆ)</span>
                </label>
                <div class="flex gap-2">
                    <input type="text" id="aiInput" placeholder="ä¾‹å¦‚ï¼šå­«å­ã€è€ç‹ã€åª³å©¦" class="flex-1 border p-2 rounded focus:outline-blue-500">
                    <button onclick="generateAiText()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-bold whitespace-nowrap flex items-center gap-1">
                        <span id="aiBtnText">ç”Ÿæˆ</span>
                        <div id="aiLoader" class="loader hidden"></div>
                    </button>
                </div>
            </div>

            <div>
                <label class="block text-gray-700 font-bold mb-2">âœï¸ è‡ªè¨‚ç¥ç¦èªï¼š</label>
                <textarea id="customText" rows="3" class="w-full border-2 border-gray-300 rounded p-2 text-xl focus:border-red-400 outline-none font-bold text-red-700" placeholder="æ—©å®‰ï¼&#10;ç¥æ‚¨é †å¿ƒå¦‚æ„">æ—©å®‰ï¼&#10;ç¥æ‚¨é †å¿ƒå¦‚æ„</textarea>
            </div>

            <div>
                <div class="flex justify-between items-end mb-2">
                    <label class="block text-gray-700 font-bold">ğŸŒ„ é¸æ“‡èƒŒæ™¯ï¼š</label>
                    <span id="festival-tag" class="hidden bg-red-100 text-red-600 text-xs px-2 py-1 rounded-full font-bold">ğŸ‰ ç¯€æ—¥æ¨è–¦ä¸­</span>
                </div>
                <div class="grid grid-cols-4 gap-2" id="bgGrid">
                    <img src="https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=200&q=80" onclick="changeBg(this.src)" class="cursor-pointer h-16 w-full object-cover rounded border-2 hover:border-red-500 ring-2 ring-transparent">
                    <img src="https://images.unsplash.com/photo-1465146344425-f00d5f5c8f07?w=200&q=80" onclick="changeBg(this.src)" class="cursor-pointer h-16 w-full object-cover rounded border-2 hover:border-red-500">
                    <img src="https://images.unsplash.com/photo-1528360983277-13d9b152c6d1?w=200&q=80" onclick="changeBg(this.src)" class="cursor-pointer h-16 w-full object-cover rounded border-2 hover:border-red-500">
                    <img src="https://images.unsplash.com/photo-1490750967868-58cb75069ed6?w=200&q=80" onclick="changeBg(this.src)" class="cursor-pointer h-16 w-full object-cover rounded border-2 hover:border-red-500">
                </div>
            </div>

            <div>
                <div class="flex justify-between mb-2">
                    <label class="block text-gray-700 font-bold">ğŸŒ¹ æ·»åŠ è²¼åœ– (é»æ“ŠåŠ å…¥)ï¼š</label>
                    <button onclick="clearStickers()" class="text-xs text-red-500 underline">æ¸…é™¤æ‰€æœ‰è²¼åœ–</button>
                </div>
                <div class="flex gap-4 overflow-x-auto pb-2 text-3xl">
                    <button onclick="addSticker('ğŸŒ¹')" class="hover:bg-gray-100 p-2 rounded transition">ğŸŒ¹</button>
                    <button onclick="addSticker('â˜•')" class="hover:bg-gray-100 p-2 rounded transition">â˜•</button>
                    <button onclick="addSticker('ğŸ™')" class="hover:bg-gray-100 p-2 rounded transition">ğŸ™</button>
                    <button onclick="addSticker('â˜€ï¸')" class="hover:bg-gray-100 p-2 rounded transition">â˜€ï¸</button>
                    <button onclick="addSticker('ğŸ')" class="hover:bg-gray-100 p-2 rounded transition">ğŸ</button>
                    <button onclick="addSticker('ğŸ‘')" class="hover:bg-gray-100 p-2 rounded transition">ğŸ‘</button>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-bold text-gray-600">æ–‡å­—é¡è‰²</label>
                    <input type="color" id="textColor" value="#FF0000" class="w-full h-10 cursor-pointer rounded">
                </div>
                <div>
                    <label class="text-sm font-bold text-gray-600">æ–‡å­—å¤§å°</label>
                    <input type="range" id="fontSize" min="30" max="100" value="60" class="w-full cursor-pointer accent-red-500">
                </div>
            </div>

            <div class="grid grid-cols-1 gap-3 pt-2">
                <button onclick="shareImage()" class="bg-[#06C755] hover:bg-[#05b34c] text-white font-bold py-3 rounded-xl text-xl shadow-md flex items-center justify-center gap-2 transition transform active:scale-95">
                    <svg viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6"><path d="M12 2C6.48 2 2 5.92 2 10.75c0 3.97 3.03 7.31 7.15 8.35-.3.94-1.1 2.58-1.28 2.97-.18.42.17.85.73.57 2.25-1.12 5.38-3.08 6.45-3.92.98.24 2.01.37 3.06.37 5.52 0 10-3.92 10-8.75S17.52 2 12 2z"/></svg>
                    LINE åˆ†äº«çµ¦å¥½å‹
                </button>
                <button onclick="downloadImage()" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 rounded-xl text-lg shadow-md">
                    â¬‡ï¸ ä¸‹è¼‰åœ–ç‰‡
                </button>
            </div>
        </div>

        <div class="flex flex-col items-center bg-gray-200 rounded-xl p-4 justify-start">
            <h3 class="text-lg font-bold text-gray-500 mb-2">åœ–ç‰‡é è¦½</h3>
            <canvas id="memeCanvas" width="500" height="500" class="bg-white w-full max-w-[500px] h-auto rounded shadow-2xl"></canvas>
            <p class="text-xs text-gray-500 mt-2">æç¤ºï¼šè‹¥ç„¡æ³•ç›´æ¥åˆ†äº«ï¼Œè«‹å…ˆä¸‹è¼‰å†å‚³é€ã€‚</p>
        </div>

    </main>

    <script>
        // --- æ ¸å¿ƒè®Šæ•¸ ---
        const canvas = document.getElementById('memeCanvas');
        const ctx = canvas.getContext('2d');
        const textInput = document.getElementById('customText');
        const textColorInput = document.getElementById('textColor');
        const fontSizeInput = document.getElementById('fontSize');
        
        // ç‹€æ…‹ç®¡ç†
        let currentBgImage = new Image();
        currentBgImage.crossOrigin = "anonymous";
        let stickers = []; // å­˜æ”¾è²¼åœ–ç‰©ä»¶ {text: 'ğŸŒ¹', x: 50, y: 50}
        
        // --- 1. åˆå§‹åŒ–èˆ‡ç¯€æ—¥åµæ¸¬ ---
        window.onload = function() {
            checkHoliday();
            // é è¨­åœ–ç‰‡
            changeBg('https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=600&q=80');
        };

        function checkHoliday() {
            const today = new Date();
            const month = today.getMonth() + 1;
            const day = today.getDate();
            const msgEl = document.getElementById('holiday-msg');
            const tagEl = document.getElementById('festival-tag');

            // ç°¡å–®çš„ç¯€æ—¥é‚è¼¯
            let greeting = "";
            let recommendText = "";

            if (month === 12 && day === 25) {
                greeting = "ğŸ„ è–èª•å¿«æ¨‚ï¼å¹³å®‰å–œæ¨‚ï¼";
                recommendText = "è–èª•ä½³ç¯€\né¡˜æ‚¨å¹³å®‰å¥åº·";
            } else if (month === 1 && day === 1) {
                greeting = "ğŸ† å…ƒæ—¦å¿«æ¨‚ï¼æ–°å¹´æ–°å¸Œæœ›ï¼";
                recommendText = "æ–°å¹´å¿«æ¨‚\nå¥½é‹æ—ºæ—ºä¾†";
            } else if (month === 5 && day >= 1 && day <= 15) { 
                // å‡è¨­æ¯è¦ªç¯€é™„è¿‘
                greeting = "ğŸŒ¸ æº«é¦¨äº”æœˆï¼Œæ„Ÿæ©æ¯è¦ª";
                recommendText = "æ¯è¦ªç¯€å¿«æ¨‚\nèº«é«”å¥åº·åƒç™¾äºŒ";
            }
            
            if (greeting) {
                msgEl.innerText = greeting;
                msgEl.classList.add('text-red-600');
                tagEl.classList.remove('hidden');
                // è‡ªå‹•å¸¶å…¥æ¨è–¦æ–‡å­—ï¼ˆä½¿ç”¨è€…å¯ä¿®æ”¹ï¼‰
                textInput.value = recommendText;
            }
        }

        // --- 2. ç¹ªåœ–æ ¸å¿ƒé‚è¼¯ ---
        function drawCanvas() {
            // æ¸…ç©º
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // ç•«èƒŒæ™¯
            if (currentBgImage.complete && currentBgImage.naturalHeight !== 0) {
                 ctx.drawImage(currentBgImage, 0, 0, canvas.width, canvas.height);
            }

            // ç•«è²¼åœ– (åœ¨æ–‡å­—ä¸‹æ–¹ï¼ŒèƒŒæ™¯ä¸Šæ–¹)
            ctx.font = "80px Arial"; // è²¼åœ–å¤§å°
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            stickers.forEach(s => {
                ctx.fillText(s.text, s.x, s.y);
            });

            // ç•«ä¸»è¦æ–‡å­—
            const fontSize = fontSizeInput.value;
            ctx.font = `bold ${fontSize}px "Noto Serif TC", "Microsoft JhengHei"`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            
            const text = textInput.value;
            const lines = text.split('\n');
            const lineHeight = parseInt(fontSize) * 1.3;
            // è¨ˆç®—æ–‡å­—å€å¡Šç¸½é«˜åº¦ï¼Œè®“å®ƒå‚ç›´ç½®ä¸­
            const startY = (canvas.height - (lines.length - 1) * lineHeight) / 2;

            lines.forEach((line, index) => {
                const y = startY + (index * lineHeight);
                const x = canvas.width / 2;

                // ç²—ç™½é‚Š (é•·è¼©åœ–éˆé­‚)
                ctx.lineWidth = 8;
                ctx.strokeStyle = 'white';
                ctx.strokeText(line, x, y);
                
                // ç´°é»‘é‚Š (å¢åŠ å°æ¯”)
                ctx.lineWidth = 2;
                ctx.strokeStyle = 'black';
                ctx.strokeText(line, x, y);

                // å¡«è‰²
                ctx.fillStyle = textColorInput.value;
                ctx.fillText(line, x, y);
            });
        }

        // --- 3. äº‹ä»¶ç›£è½ ---
        textInput.addEventListener('input', drawCanvas);
        textColorInput.addEventListener('input', drawCanvas);
        fontSizeInput.addEventListener('input', drawCanvas);

        function changeBg(src) {
            currentBgImage.src = src.replace("w=200", "w=600");
            currentBgImage.onload = drawCanvas;
        }

        // --- 4. è²¼åœ–åŠŸèƒ½ ---
        function addSticker(emoji) {
            // éš¨æ©Ÿä½ç½®ï¼Œé¿å…å…¨éƒ¨ç–Šåœ¨ä¸€èµ·
            const x = Math.random() * (canvas.width - 100) + 50;
            const y = Math.random() * (canvas.height - 100) + 50;
            stickers.push({ text: emoji, x: x, y: y });
            drawCanvas();
        }

        function clearStickers() {
            stickers = [];
            drawCanvas();
        }

        // --- 5. AI æ–‡æ¡ˆç”Ÿæˆ (æ¨¡æ“¬ API) ---
        function generateAiText() {
            const input = document.getElementById('aiInput').value;
            const btnText = document.getElementById('aiBtnText');
            const loader = document.getElementById('aiLoader');

            if (!input) {
                alert("è«‹è¼¸å…¥å°è±¡ï¼Œä¾‹å¦‚ï¼šæœ‹å‹ã€å­«å­");
                return;
            }

            // UI ç‹€æ…‹åˆ‡æ›
            btnText.innerText = "ç”Ÿæˆä¸­...";
            loader.classList.remove('hidden');

            // æ¨¡æ“¬ API å»¶é²
            setTimeout(() => {
                let result = "";
                // ç°¡å–®çš„é—œéµå­—è¦å‰‡ (åœ¨çœŸå¯¦ç’°å¢ƒä¸­ï¼Œé€™è£¡æœƒç”¨ fetch() å‘¼å« OpenAI API)
                if (input.includes("å­«")) {
                    result = "ä¹–å­«æ—©å®‰\nå¤©å†·è¨˜å¾—ç©¿å¤–å¥—\né˜¿å…¬é˜¿å¬¤æ„›ä½ ";
                } else if (input.includes("å‹") || input.includes("åŒå­¸")) {
                    result = "è€æœ‹å‹æ—©å®‰\nä¸ç®¡å¤©æ°£å¦‚ä½•\nå¿ƒæƒ…éƒ½è¦ç¾éº—";
                } else if (input.includes("å…’") || input.includes("å¥³")) {
                    result = "å¯¶è²å…’å¥³\nå·¥ä½œè¾›è‹¦äº†\nè¨˜å¾—å¤šå–æ°´";
                } else {
                    result = `çµ¦è¦ªæ„›çš„${input}\né¡˜æ‚¨ä»Šå¤©\nå……æ»¿é™½å…‰èˆ‡å–œæ¨‚`;
                }

                textInput.value = result;
                drawCanvas(); // é‡æ–°ç¹ªåœ–

                // é‚„åŸ UI
                btnText.innerText = "ç”Ÿæˆ";
                loader.classList.add('hidden');
            }, 800); 
        }

        // --- 6. åˆ†äº«èˆ‡ä¸‹è¼‰åŠŸèƒ½ ---
        
        // ä¸‹è¼‰ (å‚³çµ±æ–¹å¼)
        function downloadImage() {
            const link = document.createElement('a');
            link.download = `å•å€™åœ–_${new Date().getTime()}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        // LINE åˆ†äº« (ä½¿ç”¨ Web Share API)
        async function shareImage() {
            // æª¢æŸ¥ç€è¦½å™¨æ˜¯å¦æ”¯æ´ Web Share API
            if (!navigator.share) {
                alert("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´ç›´æ¥åˆ†äº«ï¼Œè«‹ä½¿ç”¨ã€Œä¸‹è¼‰åœ–ç‰‡ã€æŒ‰éˆ•ï¼Œå†æ‰‹å‹•å‚³åˆ° LINE å–”ï¼");
                downloadImage(); // è‡ªå‹•è§¸ç™¼ä¸‹è¼‰ç•¶ä½œå‚™æ¡ˆ
                return;
            }

            // å°‡ Canvas è½‰ç‚º Blob (æª”æ¡ˆç‰©ä»¶)
            canvas.toBlob(async (blob) => {
                const file = new File([blob], "greeting.png", { type: "image/png" });
                
                try {
                    await navigator.share({
                        title: 'ä¾†è‡ªå¥½å‹çš„ç¥ç¦',
                        text: textInput.value.replace('\n', ' '), // é è¦½æ–‡å­—
                        files: [file] // é€™æ˜¯é—œéµï¼Œç›´æ¥åˆ†äº«æª”æ¡ˆ
                    });
                    console.log('åˆ†äº«æˆåŠŸ');
                } catch (err) {
                    console.log('åˆ†äº«å–æ¶ˆæˆ–å¤±æ•—', err);
                    // å¦‚æœä½¿ç”¨è€…å–æ¶ˆåˆ†äº«ï¼Œä¸åšå‹•ä½œ
                }
            });
        }
    </script>
</body>
</html>
